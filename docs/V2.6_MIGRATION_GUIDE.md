# CyborgMind V2.5 ‚Üí V2.6 Migration Guide

**Complete upgrade path for existing installations**

---

## üìã Pre-Migration Checklist

Before upgrading, ensure:
- [ ] All training checkpoints are backed up
- [ ] Running experiments are stopped or saved
- [ ] Docker volumes are backed up (if using containers)
- [ ] Dependencies are compatible (Python 3.8+, CUDA 11.8+)

---

## üö® Breaking Changes

### 1. CC3D Adapter Removed

**What Changed:**
- `CC3DAdapter` class deleted
- `cc3d_adapter.py` removed
- All CC3D imports will fail

**Migration:**

‚ùå **V2.5 Code (Will Fail)**
```python
from cyborg_mind_v2.envs import CC3DAdapter, create_adapter

adapter = CC3DAdapter("my-simulation")
# or
adapter = create_adapter("cc3d", "my-simulation")
```

‚úÖ **V2.6 Alternative - Use Gymnasium**
```python
from cyborg_mind_v2.envs import GymAdapter

# Migrate to a standard RL environment
adapter = GymAdapter("CartPole-v1")
```

‚úÖ **V2.6 Alternative - Custom Adapter**
```python
from cyborg_mind_v2.envs import BaseEnvAdapter, BrainInputs

class MyCustomAdapter(BaseEnvAdapter):
    """
    Implement your own adapter for specialized environments.
    See docs/ADAPTER_SYSTEM.md for details.
    """
    pass
```

**Impact:** If your project requires CC3D, **stay on V2.5** or create a custom adapter.

---

### 2. Image Size Enforcement

**What Changed:**
- All adapters enforce 128√ó128 pixel observations
- Custom image sizes trigger warnings but are overridden

**Migration:**

‚ö†Ô∏è **V2.5 Code (Works, but changes behavior)**
```python
adapter = GymAdapter("Pong-v0", image_size=(64, 64))
# V2.5: Uses 64x64 images
# V2.6: Warns, then uses 128x128
```

‚úÖ **V2.6 Recommended**
```python
adapter = GymAdapter("Pong-v0")  # Implicit 128x128
# or explicit
adapter = GymAdapter("Pong-v0", image_size=(128, 128))
```

**Impact:** Models trained with different image sizes may need retraining.

---

### 3. Gymnasium API Changes

**What Changed:**
- Support for both `gym` and `gymnasium` packages
- Auto-detection of installed version
- `step()` signature differences handled internally

**Migration:**

‚úÖ **V2.6 - Works with Both**
```python
# No code changes needed!
# GymAdapter auto-detects gym vs gymnasium
adapter = GymAdapter("CartPole-v1")
```

**Install Gymnasium (Recommended)**
```bash
pip uninstall gym
pip install gymnasium
```

---

## ‚ú® New Features to Adopt

### 1. Observation Validation

**New Feature:** Detect NaN/inf in observations

‚úÖ **V2.6 Recommended**
```python
adapter = GymAdapter(
    "CartPole-v1",
    validate_obs=True  # Enable NaN detection
)
```

**Benefits:**
- Early error detection
- Clearer debugging
- Production safety

---

### 2. Error Handling

**New Feature:** Descriptive error messages

‚ö†Ô∏è **V2.5 Error (Cryptic)**
```
ValueError: shapes not aligned
```

‚úÖ **V2.6 Error (Clear)**
```
ValueError: Pixel shape mismatch: expected (3, 128, 128), got (3, 64, 64)
at gym_adapter.py:387 in _obs_to_brain_inputs
```

**Action:** Update error handling code to match new message formats.

---

### 3. Docker Deployment

**New Feature:** Production-ready containers

‚úÖ **V2.6 Quick Start**
```bash
# Build and run
docker-compose up --build

# Health check
curl http://localhost:8000/health

# Create agent
curl -X POST http://localhost:8000/agent/create \
  -H "Content-Type: application/json" \
  -d '{"env_name": "CartPole-v1"}'
```

**Benefits:**
- Isolated environments
- GPU management
- Easy scaling

---

### 4. Monitoring Stack

**New Feature:** Prometheus + Grafana

‚úÖ **V2.6 Setup**
```bash
# Start services
docker-compose up -d

# Access dashboards
open http://localhost:3000  # Grafana (admin/admin)
open http://localhost:9091  # Prometheus
```

**Metrics Available:**
- `cyborg_actions_total`
- `cyborg_memory_pressure_avg`
- `cyborg_episode_reward`
- `cyborg_nan_events_total`

---

## üîÑ Step-by-Step Upgrade

### Option 1: In-Place Upgrade (Local)

```bash
# 1. Backup
cp -r checkpoints checkpoints.backup
cp -r logs logs.backup

# 2. Update code
git pull origin main
git checkout v2.6

# 3. Update dependencies
pip install --upgrade -e .

# 4. Run tests
pytest tests/ -v

# 5. Verify
python quick_verify.py
```

### Option 2: Docker Migration (Recommended)

```bash
# 1. Stop V2.5 containers
docker-compose down

# 2. Backup volumes
docker run --rm -v cyborg_checkpoints:/backup \
  -v $(pwd)/backup:/data alpine \
  cp -r /backup /data/

# 3. Update docker-compose.yml
cp docker-compose.v2.6.yml docker-compose.yml

# 4. Build V2.6 image
docker-compose build

# 5. Start services
docker-compose up -d

# 6. Verify
docker-compose ps
curl http://localhost:8000/health
```

---

## üêõ Common Migration Issues

### Issue 1: Import Error (CC3D)

**Error:**
```
ImportError: cannot import name 'CC3DAdapter' from 'cyborg_mind_v2.envs'
```

**Fix:**
```python
# Remove CC3D imports
# from cyborg_mind_v2.envs import CC3DAdapter  # ‚ùå

# Use alternative
from cyborg_mind_v2.envs import GymAdapter  # ‚úÖ
```

---

### Issue 2: Shape Mismatch

**Error:**
```
ValueError: Pixel shape mismatch: expected (3, 128, 128), got (3, 64, 64)
```

**Fix:**
```python
# Option 1: Remove custom image_size
adapter = GymAdapter("Pong-v0")  # Uses 128x128

# Option 2: Retrain model with 128x128
python train.py --env Pong-v0 --image-size 128
```

---

### Issue 3: Gymnasium Not Installed

**Error:**
```
ModuleNotFoundError: No module named 'gymnasium'
```

**Fix:**
```bash
pip install gymnasium
# or keep old gym (still supported)
```

---

### Issue 4: Docker GPU Not Available

**Error:**
```
docker: Error response from daemon: could not select device driver
```

**Fix:**
```bash
# Install nvidia-docker
sudo apt-get install -y nvidia-docker2
sudo systemctl restart docker

# Verify GPU
docker run --rm --gpus all nvidia/cuda:11.8.0-base-ubuntu22.04 nvidia-smi
```

---

## üß™ Testing Your Migration

### Quick Verification

```python
# test_migration.py
from cyborg_mind_v2.envs import GymAdapter
from cyborg_mind_v2.integration import CyborgMindController

# Test adapter
adapter = GymAdapter("CartPole-v1", validate_obs=True)
obs = adapter.reset()
assert obs.pixels.shape == (3, 128, 128), "Pixel shape mismatch"
print("‚úì Adapter working")

# Test controller
controller = CyborgMindController(num_agents=1)
action = controller.step(
    agent_id=0,
    pixels=obs.pixels,
    scalars=obs.scalars,
    goal=obs.goal
)
print("‚úì Controller working")

# Test full episode
for _ in range(100):
    obs, reward, done, info = adapter.step(action)
    if done:
        obs = adapter.reset()
print("‚úì Episode working")

print("\nüéâ Migration successful!")
```

Run test:
```bash
python test_migration.py
```

---

## üìä Checkpoint Compatibility

### Brain Checkpoints

**V2.5 checkpoints** are **compatible** with V2.6 IF:
- ‚úÖ Same brain architecture (hidden_dim, vision_dim, etc.)
- ‚úÖ Same memory configuration (num_slots, mem_dim)
- ‚úÖ No custom CC3D-specific layers

**Load V2.5 checkpoint in V2.6:**
```python
from cyborg_mind_v2.capsule_brain.policy import BrainCyborgMind
import torch

# Load checkpoint
checkpoint = torch.load("checkpoints/model_v2.5.pth")

# Create V2.6 brain with same config
brain = BrainCyborgMind(
    action_dim=checkpoint['config']['action_dim'],
    vision_dim=checkpoint['config']['vision_dim'],
    # ... other config ...
)

# Load weights
brain.load_state_dict(checkpoint['model_state_dict'])
```

---

## üÜò Rollback Plan

If migration fails:

```bash
# Option 1: Git rollback
git checkout v2.5
pip install -e .

# Option 2: Docker rollback
docker-compose down
docker pull cyborgmind:v2.5
docker-compose up -d

# Option 3: Restore from backup
rm -rf checkpoints logs
mv checkpoints.backup checkpoints
mv logs.backup logs
```

---

## üìû Support

**Need help?**
- GitHub Issues: https://github.com/dawsonblock/cyborg_mind/issues
- Email: support@cyborgmind.ai
- Docs: docs/

---

## ‚úÖ Migration Checklist

- [ ] Backed up checkpoints and logs
- [ ] Removed CC3D dependencies
- [ ] Updated to gymnasium (or kept gym)
- [ ] Set image_size to 128x128
- [ ] Enabled observation validation
- [ ] Tested adapter creation
- [ ] Tested controller step
- [ ] Ran full episode
- [ ] Verified metrics collection
- [ ] Updated Docker Compose (if using)
- [ ] Tested health checks
- [ ] Verified checkpoint loading
- [ ] Updated CI/CD pipelines
- [ ] Informed team of changes

---

**Migration complete? Welcome to V2.6! üöÄ**
